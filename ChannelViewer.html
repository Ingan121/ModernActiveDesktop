<!DOCTYPE html>
<html>
    <head>
        <title>ModernActiveDesktop - ChannelViewer</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="ChannelViewer/ChannelViewer.css">
        <link rel="stylesheet" href="98.css">
        <link id="scheme" rel="stylesheet" href="data:text/css,">
    </head>
    <body style="background-attachment: fixed; background-position: center center; background-repeat: no-repeat; border: none; background-color: #008080;">
        <iframe id="bgHtml" src="bghtml/index.html"></iframe>
        <div id="container">
            <div style="height: 26px; background-color: var(--button-face);">
                <div id="not-so-grabber"></div>
                <div id="back-button" class="toolbarButton" onclick="history.back();" onmouseover="this.getElementsByTagName('img')[0].src = 'ChannelViewer/Back_hover.png';" onmouseout="this.getElementsByTagName('img')[0].src = 'ChannelViewer/Back.png';">
                    <img class="toolbarButtonImage" src="ChannelViewer/Back.png">
                </div>
                <div id="forward-button" class="toolbarButton" onclick="history.forward();" onmouseover="this.getElementsByTagName('img')[0].src = 'ChannelViewer/Forward_hover.png';" onmouseout="this.getElementsByTagName('img')[0].src = 'ChannelViewer/Forward.png';">
                    <img class="toolbarButtonImage" src="ChannelViewer/Forward.png">
                </div>
                <p id="loadingText">Loading...</p>
                <div style="width: 18px; height: 26px; background-color: black; margin-left: auto;">
                    <div class="windowBtn-ChanView">
                        <p style="color: #808080; font-size: 12px; text-align: center; margin-top: -3px;" onclick="location.href = 'index.html';">üóô</p>
                    </div>
                </div>
            </div>
            <iframe id="iframe" src="data:text/plain,Loading..." onload="document.getElementById('loadingText').style.display = 'none';"></iframe>
        </div>
        <script>
            const iframe = document.getElementById("iframe");
            const container = document.getElementById("container");
            const schemeElement = document.getElementById("scheme");

            //ÏÑ§Ï†ïÍ∞í Î∂àÎü¨Ïò§Í∏∞
            if (localStorage.madesktopBgColor) document.body.style.backgroundColor = localStorage.madesktopBgColor;
            if (localStorage.madesktopBgImg) document.body.style.backgroundImage = "url('" + localStorage.madesktopBgImg + "')";
            changeBgImgMode(localStorage.madesktopBgImgMode ? localStorage.madesktopBgImgMode : "center");
            if (localStorage.madesktopColorScheme) changeColorScheme(localStorage.madesktopColorScheme, false);
            if (localStorage.madesktopChanViewLeftMargin) container.style.marginLeft = localStorage.madesktopChanViewLeftMargin;
            if (localStorage.madesktopChanViewRightMargin) container.style.marginRight = localStorage.madesktopChanViewRightMargin;

            //ÏõîÌéòÏù¥Ìçº ÏóîÏßÑ ÏÜçÏÑ±Í∞í Î≥ÄÍ≤Ω Í∞êÏßÄ
            window.wallpaperPropertyListener = {
                applyUserProperties: function(properties) {
                    if (properties.bgcolor) {
                        changeBgColor(parseWallEngColorProp(properties.bgcolor.value));
                    }
                    if (properties.bgimg) {
                        if (properties.bgimg.value) {
                            var path = "file:///" + properties.bgimg.value;
                            document.body.style.backgroundImage = "url('" + path + "')";
                            localStorage.madesktopBgImg = path;
                        } else {
                            document.body.style.backgroundImage = 'none';
                            localStorage.removeItem('bgImg');
                        }
                    }
                    if (properties.bgimgmode) {
                        changeBgImgMode(properties.bgimgmode.value);
                        localStorage.madesktopBgImgMode = properties.bgimgmode.value;
                    }
                    if (properties.additem) {
                        if (!properties.bgcolor) { // Ignore if this is a startup event
                            alert("Please close the ChannelViewer first then try again.");
                        }
                    }
                    if (properties.nonadstyle) {
                        if (properties.nonadstyle.value) localStorage.madesktopNonADStyle = true;
                        else localStorage.removeItem("madesktopNonADStyle");
                    }
                    if (properties.leftmargin) {
                        var str = isNaN(properties.leftmargin.value) ? properties.leftmargin.value : properties.leftmargin.value + 'px';
                        container.style.marginLeft = str;
                        localStorage.madesktopChanViewLeftMargin = str;
                    }
                    if (properties.rightmargin) {
                        var str = isNaN(properties.rightmargin.value) ? properties.rightmargin.value : properties.rightmargin.value + 'px';
                        container.style.marginRight = str;
                        localStorage.madesktopChanViewRightMargin = str;
                    }
                    if (properties.sysplugintegration) {
                        if (!properties.bgcolor) { // Ignore if this is a startup event
                            if (properties.sysplugintegration.value) {
                                localStorage.sysplugIntegration = true;

                                fetch("http://localhost:3031/connecttest")
                                .then(response => response.text())
                                .then(responseText => {
                                    if (responseText != "OK") {
                                        alert("An error occured!\nSystem plugin response: " + responseText);
                                    }
                                })
                                .catch(error => {
                                    alert("System plugin is not running. Please make sure you have installed it properly. If you don't want to use it, please disable the system plugin integration option.");
                                })
                            } else {
                                localStorage.removeItem("sysplugIntegration");
                                if (localStorage.madesktopColorScheme == "sys") localStorage.removeItem("madesktopColorScheme");
                            }
                        }
                    }
                    if (properties.openwith) {
                        if (!properties.bgcolor) { // Ignore if this is a startup event
                            if (localStorage.madesktopPrevOWConfigRequest != properties.openwith.value) {
                                fetch("http://localhost:3031/config", { method: "POST", body: `{"openWith": ${properties.openwith.value}}` })
                                    .then(response => response.text())
                                    .then(responseText => {
                                        if (responseText != "OK") {
                                            alert("An error occured!\nSystem plugin response: " + responseText);
                                        }
                                    })
                                    .catch(error => {
                                        alert(NO_SYSPLUG_ALERT);
                                        createNewDeskItem("SysplugSetupGuide.md", true);
                                        localStorage.madesktopItemCount++;
                                    });
                            }
                        }
                        localStorage.madesktopPrevOWConfigRequest = properties.openwith.value;
                    }
                    if (properties.colorscheme || properties.colorscheme2) {
                        const value = localStorage.sysplugIntegration ? properties.colorscheme.value : properties.colorscheme2.value;
                        changeColorScheme(value);
                        if (!properties.leftmargin) changeBgColor("var(--background)"); // Don't change the background color if this is a startup event
                        localStorage.madesktopColorScheme = value;
                    }
                    if (properties.reset) {
                        if (!properties.bgcolor) { // Ignore if this is a startup event
                            if (confirm("If you want to reset all the configurations completely, please cancel now, click the big red Reset button below first, then click this button again and continue.")) {
                                if (confirm("This will remove every configuration changes of ModernActiveDesktop you made. Are you sure you want to continue?")) {
                                    localStorage.clear();
                                    alert("Reset complete. The wallpaper will now reload.");
                                    location.href = 'index.html';
                                }
                            }
                        }
                    }
                }
            };

            //ÏÉâÏÉÅ ÏÑ†ÌÉù Î≤ÑÌäº Î∞è Î∞∞Í≤ΩÏÉâ ÏÑ§Ï†ïÍ∞íÍ≥º Ìï®Íªò Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω
            function changeBgColor(str) {
                document.body.style.backgroundColor = str;
                localStorage.madesktopBgColor = str;
            }

            //Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Ï±ÑÏö∞Í∏∞ Î™®Îìú Î≥ÄÍ≤Ω
            function changeBgImgMode(value) {
                switch (value) {
                    case "center": //Í∞ÄÏö¥Îç∞
                        document.body.style.backgroundSize = "auto";
                        document.body.style.backgroundRepeat = "no-repeat";
                        document.body.style.backgroundPosition = "center center";
                    break;
                    case "grid": //Î∞îÎëëÌåêÏãù
                        document.body.style.backgroundSize = "auto";
                        document.body.style.backgroundRepeat = "repeat";
                        document.body.style.backgroundPosition = "left top";
                    break;
                    case "horizfit": //ÏÑ∏Î°ú ÎßûÏ∂§
                        document.body.style.backgroundSize = "contain";
                        document.body.style.backgroundRepeat = "no-repeat";
                        document.body.style.backgroundPosition = "center center";
                    break;
                    case "vertfit": //Í∞ÄÎ°ú ÎßûÏ∂§
                        document.body.style.backgroundSize = "cover";
                        document.body.style.backgroundRepeat = "no-repeat";
                        document.body.style.backgroundPosition = "center center";
                    break;
                    case "scale": //ÎäòÏù¥Í∏∞
                        document.body.style.backgroundSize = "100% 100%";
                        document.body.style.backgroundRepeat = "no-repeat";
                        document.body.style.backgroundPosition = "center center";
                    break;
                }
            }

            function changeColorScheme(scheme) {
                if (scheme == "98") schemeElement.href = "data:text/css,";
                else if (scheme != "sys") schemeElement.href = `schemes/${scheme}.css`;
                else {
                    if (localStorage.madesktopSysColorCache) schemeElement.href = localStorage.madesktopSysColorCache;

                    fetch("http://localhost:3031/systemscheme")
                        .then(response => response.text())
                        .then(responseText => {
                            const dataURL = `data:text/css,${encodeURIComponent(responseText)}`;
                            schemeElement.href = dataURL;
                            localStorage.madesktopSysColorCache = dataURL; // Cache it as SysPlug startup is slower than high priority WE startup
                        })
                        .catch(error => {
                            // Ignore it as SysPlug startup is slower than high priority WE startup
                        })
                }
            }

            //ÌéòÏù¥ÎìúÏù∏ Ìö®Í≥º
            function fadeIn(elem) {
                var i = 0.1;
                elem.style.opacity = i;
                elem.style.filter = "alpha(opacity=" + i * 100 + ")";
                elem.style.display = "block";
                settingsWindow.style.marginTop = -(settingsWindow.getBoundingClientRect().height / 2) + 'px';
                var interval = setInterval(function () {
                    if (i >= 1){
                        clearInterval(interval);
                    }
                    elem.style.opacity = i;
                    elem.style.filter = "alpha(opacity=" + i * 100 + ")";
                    i += i * 0.1;
                }, 5);
                setTimeout(function() {
                    clearInterval(interval);
                    elem.style.opacity = 1;
                    elem.style.filter = "alpha(opacity=" + 100 + ")";
                }, 500);
            }

            //ÌéòÏù¥ÎìúÏïÑÏõÉ Ìö®Í≥º
            function fadeOut(elem) {
                var i = 1; 
                var interval = setInterval(function () {
                    if (i <= 0.1){
                        clearInterval(interval);
                        elem.style.display = "none";
                    }
                    elem.style.opacity = i;
                    elem.style.filter = "alpha(opacity=" + i * 100 + ")";
                    i -= i * 0.1;
                }, 5);
                setTimeout(function() {
                    clearInterval(interval);
                    elem.style.display = "none";
                }, 500);
            }

            //rgb(red, green, blue) ÌòïÏãùÏùò ÏÉâÏÉÅ ÏΩîÎìúÎ•º #rrggbb ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
            function rgbToHex(rgbType) {
                var rgb = rgbType.replace(/[^%,.\d]/g, "").split(",");
            
                for (var x = 0; x < 3; x++) {
                    if (rgb[x].indexOf("%") > -1) rgb[x] = Math.round(parseFloat(rgb[x]) * 2.55); 
                }
            
                var toHex = function(string) {
                    string = parseInt(string, 10).toString(16);
                    string = (string.length === 1) ? "0" + string : string;
                
                    return string;
                };
            
                var r = toHex(rgb[0]);
                var g = toHex(rgb[1]);
                var b = toHex(rgb[2]);
            
                var hexType = "#" + r + g + b;
            
                return hexType;
            }

            //ÏõîÌéòÏù¥Ìçº ÏóîÏßÑÏù¥ Î≥¥ÎÇ¥Ï£ºÎäî ÏÉâÏÉÅÍ∞í ÌòïÏãùÏùÑ #rrggbb ÌòïÏãùÎ°ú Î≥ÄÌôò
            function parseWallEngColorProp(value) {
                var customColor = value.split(' ');
                customColor = customColor.map(function(c) {
                    return Math.ceil(c * 255);
                });
                return rgbToHex('rgb(' + customColor + ')');
            }

            //ÏÑ§Ï†ïÏ∞ΩÏóêÏÑú RomanHue Í∏ÄÏûê ÎàÑÎ•¥Î©¥ Îú®Îäî ÎîîÎ≤ÑÍπÖÏö© Í∏∞Îä•
            function debug() {
                eval(prompt("Ïã§ÌñâÌï† ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏ ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏã≠ÏãúÏò§. (ÎîîÎ≤ÑÍπÖÏö©)"));
                function loadEruda() { //Eruda Í∞úÎ∞úÏûê ÎèÑÍµ¨ Î°úÎìú (Í∑ºÎç∞ ÏõîÌéòÏù¥Ìçº ÏóîÏßÑ ÏÑ§Ï†ïÏóêÏÑú CEF devtools Ìè¨Ìä∏ ÏÑ§Ï†ïÌï¥ÏÑú ÌÅ¨Î°¨ Í∞úÎ∞úÏûêÎèÑÍµ¨ Ïì∞ÎäîÍ≤å Îçî ÎÇòÏùå)
                    var script = document.createElement('script');
                    script.src="https://cdn.jsdelivr.net/npm/eruda";
                    document.body.appendChild(script);
                    script.onload = function () {
                        eruda.init();
                    };
                }
            }

            var url = new URL(location.href);
            if (url.searchParams.get("sb") !== null) iframe.sandbox = "allow-modals allow-scripts";
            iframe.src = url.searchParams.get("page") || "data:text/plain,Nothing loaded!";
            iframe.contentWindow.onunload = function () {
                document.getElementById('loadingText').style.display = 'block';
            }
        </script>
    </body>
</html>
